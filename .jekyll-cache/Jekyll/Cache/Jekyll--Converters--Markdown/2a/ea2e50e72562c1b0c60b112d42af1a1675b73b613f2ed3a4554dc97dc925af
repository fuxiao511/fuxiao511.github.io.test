I"£<h1 id="vpidvirtual-processor-id">VPIDï¼ˆVirtual Processor IDï¼‰</h1>

<h2 id="eptåœ°å€è½¬æ¢">EPTåœ°å€è½¬æ¢</h2>

<p>GVAâ€”â€”GPAâ€”â€”HPA</p>

<ul>
  <li>
    <p>è½¯ä»¶æ¨¡å¼ï¼š</p>

    <ul>
      <li>æ¯æ¬¡å¯¹CR3å’Œé¡µè¡¨çš„è®¿é—®éƒ½é€€å‡ºåˆ°VMMï¼ŒVMMå°†ä¸¤æ¬¡åœ°å€è½¬æ¢çš„é¡µè¡¨ç»“åˆèµ·æ¥å½¢æˆå½±å­é¡µè¡¨</li>
      <li>æ¯æ¬¡è®¿é—®éƒ½éœ€è¦é™·å‡ºï¼Œæ•ˆç‡é—®é¢˜</li>
      <li>VMMéœ€è¦ä¸º<strong>æ¯ä¸ªè™šæ‹Ÿæœº*æ¯ä¸ªè¿›ç¨‹</strong>ç»´æŠ¤é¡µè¡¨ï¼Œå ç”¨å†…å­˜èµ„æº</li>
    </ul>
  </li>
  <li>
    <p>EPTç¡¬ä»¶æ¨¡å¼ï¼š</p>

    <ul>
      <li>
        <p>EPTå°†GPAè½¬åŒ–ä¸ºHPA</p>
      </li>
      <li>
        <p>VMMä»…éœ€è¦ä¸º<strong>æ¯ä¸ªè™šæ‹Ÿæœº</strong>ç»´æŠ¤é¡µè¡¨ï¼ŒVMMè´Ÿè´£è®¾ç½®EPTæ‰€éœ€çš„é¡µè¡¨å…¥å£åœ°å€ï¼Œå­˜æ”¾åœ¨VMCS-EPTPä¸­</p>
      </li>
    </ul>
  </li>
</ul>

<h2 id="eptä¹Ÿéœ€è¦cacheåŠ é€Ÿ">EPTä¹Ÿéœ€è¦cacheåŠ é€Ÿ</h2>

<ul>
  <li>Linear mapping
    <ul>
      <li>Linear translations   ç±»ä¼¼TLBï¼Œç”¨äºGVAâ€”â€”GPAçš„è½¬æ¢åŠ é€Ÿ</li>
      <li>Linear paging-structure-cache ç±»ä¼¼Paging-Structure Cacheï¼Œç”¨äºGVAâ€”â€”GPAçš„åœ°å€è½¬æ¢é¡µè¡¨åŠ é€Ÿ</li>
    </ul>
  </li>
  <li>Guest-physical
    <ul>
      <li>Guest-physical translations ç±»ä¼¼TLBï¼Œç”¨äºGPAâ€”â€”HPAçš„è½¬æ¢åŠ é€Ÿ</li>
      <li>Guest-physical paging-structure-cache  ç±»ä¼¼Paging-Structure Cacheï¼Œç”¨äºGPAâ€”â€”HPAçš„åœ°å€è½¬æ¢é¡µè¡¨åŠ é€Ÿ</li>
    </ul>
  </li>
  <li>Combined mapping
    <ul>
      <li>Combined translations  ç±»ä¼¼TLBï¼Œç›´æ¥ç”¨äºGVAâ€”â€”HPAçš„è½¬æ¢åŠ é€Ÿï¼Œè™šæ‹Ÿæœºçš„page numberç›´æ¥åˆ°ç‰©ç†æœºçš„page frame</li>
      <li>Combined paging-structure-cache ç±»ä¼¼Paging-Structure Cacheï¼Œç›´æ¥ç”¨äºGVAâ€”â€”HPAçš„åœ°å€è½¬é¡µè¡¨åŠ é€Ÿ</li>
      <li>è¿™ç§æ–¹å¼VMMéœ€è¦ä¸º<strong>æ¯ä¸ªè™šæ‹Ÿæœº*æ¯ä¸ªè¿›ç¨‹</strong>ç»´æŠ¤é¡µè¡¨ï¼Œå› ä¸ºGVAæ˜¯å±äºè¿›ç¨‹çš„</li>
    </ul>
  </li>
</ul>

<h2 id="ä¸åŒvcpuçš„cacheå¯ä»¥åŒæ—¶ä¿å­˜åœ¨ç¡¬ä»¶cacheä¸­">ä¸åŒvcpuçš„cacheå¯ä»¥åŒæ—¶ä¿å­˜åœ¨ç¡¬ä»¶cacheä¸­</h2>

<ul>
  <li>vcpuåœ¨æ¯æ¬¡VM Entryå’ŒVM Exitæ—¶ä¸éœ€è¦æ‰§è¡Œflushæ“ä½œï¼Œä¸”å¯ä»¥ä¿å­˜å¤šä¸ªvcpuçš„cacheï¼Œæé«˜æ€§èƒ½</li>
  <li>ä¸ºæ­¤å¼•å…¥VPIDï¼ˆVirtual Processor  IDï¼‰</li>
  <li>ä¸ºæ¯ä¸ªåœ°å€è½¬æ¢çš„Cacheï¼ˆTLBæˆ–è€…Paging-Structure Cacheï¼‰æ‰“ä¸Šä¸€ä¸ªVPIDçš„æ ‡å¿—ï¼ˆVMMä¸ºæ¯ä¸ªvCPUåˆ†é…ä¸€ä¸ªå”¯ä¸€çš„VPIDï¼ˆä½äºVMCSä¸­ï¼‰ï¼Œé€»è¾‘CPUçš„VPIDä¸º0ï¼Œå…¶ä»–vCPUçš„VPIDå¤§äº0ï¼‰</li>
  <li>EPTç¡¬ä»¶å¯»æ‰¾cacheæ—¶ï¼Œå°†å½“å‰è¿è¡Œçš„vCPU/CPUçš„VPIDå’ŒCacheä¸­æ‰€åŒ…å«çš„VPIDè¿›è¡ŒåŒ¹é…ï¼Œåªæœ‰ç›¸ç­‰æ‰ä¼šä½¿ç”¨è¯¥Cacheæ¡ç›®ã€‚</li>
</ul>

<h2 id="invvpid">INVVPID</h2>

<p><img src="VPID.assets/INVVPIDæŒ‡ä»¤.png" alt="image-20220527103541203" /></p>

<p>Invalidates mappings in the translation lookaside buffers (TLBs) and paging-structure caches based on virtualprocessor identifier (VPID). (See Chapter 28, â€œVMX Support for Address Translationâ€.) Invalidation is based on the INVVPID type specified in the register operand and the INVVPID descriptor specified in the memory operand.</p>

<p>ç¬¬ä¸€ä¸ªæ˜¯å¯„å­˜å™¨å‚æ•°ï¼Œè¡¨ç¤ºç±»å‹ï¼Œç¬¬äºŒä¸ªå†…å­˜å‚æ•°è¡¨ç¤ºæè¿°ç¬¦</p>

<p><img src="VPID.assets/INVVPIDæè¿°ç¬¦.png" alt="image-20220527105100302" /></p>

<p><img src="VPID.assets/invvpidæ±‡ç¼–å‘½ä»¤.png" alt="invvpidæ±‡ç¼–å‘½ä»¤" /></p>

<ul>
  <li><strong>INVVPID</strong>æ”¯æŒå››ç§ç±»å‹ï¼Œä¸<strong>INVPCID</strong>çš„æ“ä½œä¿æŒä¸€è‡´ï¼š
    <ul>
      <li>INVVPID
        <ul>
          <li>#define <strong>VMX_VPID_EXTENT_INDIVIDUAL_ADDR</strong>         0
  #define VMX_VPID_EXTENT_SINGLE_CONTEXT          1
  #define VMX_VPID_EXTENT_ALL_CONTEXT             2
  #define VMX_VPID_EXTENT_SINGLE_NON_GLOBAL       3</li>
        </ul>
      </li>
      <li></li>
      <li>INVPCID
        <ul>
          <li>0ã€INVPCID_TYPE_INDIV_ADDRâ€”â€”invalidateå•ä¸ªçº¿æ€§åœ°å€</li>
          <li>1ã€INVPCID_TYPE_SINGLE_CTXTâ€”â€”invalidateæŒ‡å®šPCIDä¸‹çš„æ‰€æœ‰åœ°å€</li>
          <li>2ã€INVPCID_TYPE_ALL_INCL_GLOBALâ€”â€”invalidateæ‰€æœ‰PCIDæ‰€æœ‰æ¡ç›®åŒ…æ‹¬globals</li>
          <li>3ã€INVPCID_TYPE_ALL_NON_GLOBALâ€”â€”invalidateæ‰€æœ‰PCIDæ‰€æœ‰æ¡ç›®ä¸åŒ…æ‹¬globals</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>handle_invlpg è™šæ‹Ÿæœºå†…éƒ¨çš„tlbç¼“å­˜å¤±æ•ˆï¼Œæ˜¯é€šè¿‡INVVPIDå®ç°çš„
    <ul>
      <li>kvm_mmu_invalidate_gva
        <ul>
          <li>if (mmu != &amp;vcpu-&gt;arch.guest_mmu) {</li>
          <li>static_call(kvm_x86_flush_tlb_gva)</li>
          <li>å®é™…è°ƒç”¨kvm_x86_ops <strong>vmx_x86_ops</strong>-&gt;flush_tlb_gva = <strong>vmx_flush_tlb_gva</strong>
            <ul>
              <li>é€šè¿‡vpid_sync_vcpu_addrè°ƒç”¨invvpidå°†è¿›ç¨‹çš„<strong>gva_tåœ°å€</strong>flushæ‰
                <ul>
                  <li>__invvpid(<strong>VMX_VPID_EXTENT_INDIVIDUAL_ADDR</strong>, vpid, addr);</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>handle_invpcid è™šæ‹Ÿæœºå†…éƒ¨çš„tlbç¼“å­˜å¤±æ•ˆï¼Œé€šè¿‡INVVPIDå®ç°
    <ul>
      <li>handle_invpcid å…ˆè·å–è™šæ‹Ÿæœºå†…éƒ¨invpcidæŒ‡ä»¤çš„ä¸¤ä¸ªå‚æ•°</li>
      <li>kvm_register_readè·å–ç¬¬ä¸€ä¸ªtypeå‚æ•°</li>
      <li>get_vmx_mem_addressè·å–ç¬¬äºŒä¸ªgvaå‚æ•°
        <ul>
          <li>kvm_read_guest_virt
            <ul>
              <li>gva_to_gpaè·å–gvaåœ°å€é‡Œçš„å†…å®¹ï¼Œéœ€è¦è½¯ä»¶éå†è™šæ‹Ÿæœºçš„é¡µè¡¨è·å¾—gpa</li>
              <li>kvm_vcpu_read_guest_page å†è®²gpaè½¬åŒ–ä¸ºhvaè¿›è¡Œè¯»å–</li>
            </ul>
          </li>
          <li>æ ¹æ®typeç±»å‹å¦‚æœåªinvalidateä¸€ä¸ªgvaåœ°å€ï¼Œè°ƒç”¨kvm_mmu_invpcid_gva
            <ul>
              <li>mmu-&gt;invlpg  TDPæ—¶ä¸ºNULL</li>
              <li>static_call(kvm_x86_flush_tlb_gva)å³<strong>vmx_flush_tlb_gva</strong></li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

:ET